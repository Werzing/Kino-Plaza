<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель - КиноПлаза</title>
    <link rel="icon" type="image/x-icon" href="logo.png">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            padding: 2rem;
            background: var(--card-bg);
            border-radius: 8px;
            text-align: center;
        }
        
        .admin-panel {
            display: none;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .admin-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1rem;
        }
        
        .tab {
            padding: 0.7rem 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.7rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
        }
        
        .btn {
            padding: 0.7rem 1.5rem;
            background: var(--accent-red);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem;
        }
        
        .btn-secondary {
            background: var(--border-color);
        }
        
        .items-list {
            display: grid;
            gap: 1rem;
        }
        
        .item-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-left: 4px solid var(--accent-red);
        }
        
        .item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border-top: 4px solid var(--accent-red);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-red);
            margin-bottom: 0.5rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        .logout-btn {
            background: var(--soft-red);
            margin-left: auto;
        }
        
        .site-link {
            background: var(--accent-red);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="film-frames"></div>
        <div class="header-content">
            <div class="logo">
                <span class="logo-kino">Кино</span>
                <span class="logo-plaza">Плаза</span>
            </div>
            <nav class="nav">
                <div class="nav-item site-link" onclick="goToSite()">На сайт</div>
                <div class="nav-item active">Админ-панель</div>
                <div class="nav-item logout-btn" id="logoutBtn" style="display: none;" onclick="logout()">Выйти</div>
            </nav>
        </div>
    </header>

    <div id="loginForm" class="login-form">
        <h2>Вход в админ-панель</h2>
        <div class="form-group">
            <label>Логин</label>
            <input type="text" id="username" placeholder="Введите логин">
        </div>
        <div class="form-group">
            <label>Пароль</label>
            <input type="password" id="password" placeholder="Введите пароль">
        </div>
        <button class="btn" onclick="login()">Войти</button>
        <div id="loginError" style="color: var(--accent-red); margin-top: 1rem; display: none;">
            Неверный логин или пароль
        </div>
        <div style="margin-top: 1rem; color: var(--text-muted); font-size: 0.9rem;">
            Тестовые данные:<br>
            Логин: <strong>admin</strong><br>
            Пароль: <strong>admin123</strong>
        </div>
    </div>

    <div id="adminPanel" class="admin-panel">
        <h2>Панель управления</h2>
        
        <!-- Статистика -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="moviesCount">0</div>
                <div>Фильмов</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="directorsCount">0</div>
                <div>Режиссеров</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="genresCount">0</div>
                <div>Жанров</div>
            </div>
        </div>

        <!-- Навигация по таблицам -->
        <div class="admin-tabs">
            <div class="tab active" onclick="showTab('movies')">Фильмы</div>
            <div class="tab" onclick="showTab('directors')">Режиссеры</div>
            <div class="tab" onclick="showTab('genres')">Жанры</div>
        </div>

        <!-- Секция фильмов -->
        <div id="moviesTab" class="tab-content active">
            <div class="form-section">
                <h3>Добавить новый фильм</h3>
                <form id="movieForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Название фильма *</label>
                            <input type="text" id="movieTitle" required>
                        </div>
                        <div class="form-group">
                            <label>Год выпуска *</label>
                            <input type="number" id="movieYear" min="1900" max="2030" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Жанр</label>
                            <select id="movieGenre">
                                <option value="">Выберите жанр</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Режиссер</label>
                            <select id="movieDirector">
                                <option value="">Выберите режиссера</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Страна</label>
                            <input type="text" id="movieCountry">
                        </div>
                        <div class="form-group">
                            <label>Длительность (минуты)</label>
                            <input type="number" id="movieDuration">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Рейтинг</label>
                            <input type="number" step="0.1" id="movieRating" min="0" max="10">
                        </div>
                        <div class="form-group">
                            <label>Возрастной рейтинг</label>
                            <input type="text" id="movieAgeRating" placeholder="PG-13, R, etc.">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Бюджет</label>
                        <input type="number" id="movieBudget" placeholder="В долларах">
                    </div>
                    
                    <div class="form-group">
                        <label>Описание</label>
                        <textarea id="moviePlot" rows="4"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>URL постера</label>
                        <input type="url" id="moviePoster">
                    </div>
                    
                    <button type="button" class="btn" onclick="addMovie()">Добавить фильм</button>
                </form>
            </div>

            <div class="form-section">
                <h3>Список фильмов</h3>
                <div id="moviesList" class="items-list">
                    <div class="loading">Загрузка фильмов...</div>
                </div>
            </div>
        </div>

        <!-- Секция режиссеров -->
        <div id="directorsTab" class="tab-content">
            <div class="form-section">
                <h3>Добавить режиссера</h3>
                <form id="directorForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Полное имя *</label>
                            <input type="text" id="directorName" required>
                        </div>
                        <div class="form-group">
                            <label>Год рождения</label>
                            <input type="number" id="directorBirthYear" min="1800" max="2024">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Страна</label>
                        <input type="text" id="directorCountry">
                    </div>
                    <button type="button" class="btn" onclick="addDirector()">Добавить режиссера</button>
                </form>
            </div>

            <div class="form-section">
                <h3>Список режиссеров</h3>
                <div id="directorsList" class="items-list">
                    <div class="loading">Загрузка режиссеров...</div>
                </div>
            </div>
        </div>

        <!-- Секция жанров -->
        <div id="genresTab" class="tab-content">
            <div class="form-section">
                <h3>Добавить жанр</h3>
                <form id="genreForm">
                    <div class="form-group">
                        <label>Название жанра *</label>
                        <input type="text" id="genreName" required>
                    </div>
                    <button type="button" class="btn" onclick="addGenre()">Добавить жанр</button>
                </form>
            </div>

            <div class="form-section">
                <h3>Список жанров</h3>
                <div id="genresList" class="items-list">
                    <div class="loading">Загрузка жанров...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://syqlznhvvqfadbbqeltk.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5cWx6bmh2dnFmYWRiYnFlbHRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MzU5MzAsImV4cCI6MjA3NTMxMTkzMH0.JjFICdfFnFwp0_jfSxKIOn1Je87ZtMRPSTFvjxYF3-k';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentTab = 'movies';

        // Проверяем авторизацию при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });

        // Проверяем авторизацию
        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            if (isLoggedIn === 'true') {
                showAdminPanel();
            } else {
                showLoginForm();
            }
        }

        // Функция входа
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                // Простая проверка логина и пароля
                if (username === 'admin' && password === 'admin123') {
                    // Сохраняем в sessionStorage (сохраняется до закрытия вкладки)
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    showAdminPanel();
                } else {
                    showLoginError();
                }
            } catch (error) {
                console.error('Ошибка входа:', error);
                showLoginError();
            }
        }

        // Функция выхода
        function logout() {
            // Полностью сбрасываем авторизацию
            sessionStorage.removeItem('adminLoggedIn');
            
            // Очищаем поля ввода
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Показываем форму входа
            showLoginForm();
        }

        // Переход на сайт (без сброса авторизации)
        function goToSite() {
            window.location.href = 'index.html';
        }

        function showLoginError() {
            document.getElementById('loginError').style.display = 'block';
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('loginError').style.display = 'none';
        }

        function showAdminPanel() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('loginError').style.display = 'none';
            loadAllData();
        }

        // Переключение вкладок
        function showTab(tabName) {
            currentTab = tabName;
            
            // Обновляем активные табы
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Загрузка всех данных
        async function loadAllData() {
            await loadMovies();
            await loadDirectors();
            await loadGenres();
            await loadStats();
            await populateSelects();
        }

        // Загрузка статистики
        async function loadStats() {
            try {
                const [moviesRes, directorsRes, genresRes] = await Promise.all([
                    supabase.from('movies').select('*', { count: 'exact', head: true }),
                    supabase.from('directors').select('*', { count: 'exact', head: true }),
                    supabase.from('genres').select('*', { count: 'exact', head: true })
                ]);

                document.getElementById('moviesCount').textContent = moviesRes.count || 0;
                document.getElementById('directorsCount').textContent = directorsRes.count || 0;
                document.getElementById('genresCount').textContent = genresRes.count || 0;
            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
            }
        }

        // Заполнение выпадающих списков
        async function populateSelects() {
            try {
                // Жанры для фильмов
                const { data: genres, error: genresError } = await supabase
                    .from('genres')
                    .select('*')
                    .order('name');
                
                if (genresError) throw genresError;
                
                const genreSelect = document.getElementById('movieGenre');
                genreSelect.innerHTML = '<option value="">Выберите жанр</option>';
                genres.forEach(genre => {
                    genreSelect.innerHTML += `<option value="${genre.id}">${genre.name}</option>`;
                });

                // Режиссеры для фильмов
                const { data: directors, error: directorsError } = await supabase
                    .from('directors')
                    .select('*')
                    .order('full_name');
                
                if (directorsError) throw directorsError;
                
                const directorSelect = document.getElementById('movieDirector');
                directorSelect.innerHTML = '<option value="">Выберите режиссера</option>';
                directors.forEach(director => {
                    directorSelect.innerHTML += `<option value="${director.id}">${director.full_name}</option>`;
                });
            } catch (error) {
                console.error('Ошибка загрузки списков:', error);
            }
        }

        // === ФУНКЦИИ ДЛЯ ФИЛЬМОВ ===
        async function loadMovies() {
            try {
                const { data: movies, error } = await supabase
                    .from('movies')
                    .select(`
                        *,
                        genres(name),
                        directors(full_name)
                    `)
                    .order('release_year', { ascending: false });

                if (error) throw error;

                displayMovies(movies);
            } catch (error) {
                console.error('Ошибка загрузки фильмов:', error);
                document.getElementById('moviesList').innerHTML = 
                    '<div class="loading">Ошибка загрузки фильмов: ' + error.message + '</div>';
            }
        }

        function displayMovies(movies) {
            const container = document.getElementById('moviesList');
            
            if (!movies || movies.length === 0) {
                container.innerHTML = '<div class="loading">Фильмы не найдены</div>';
                return;
            }

            container.innerHTML = movies.map(movie => `
                <div class="item-card">
                    <div style="flex: 1;">
                        <strong>${movie.title}</strong> (${movie.release_year})
                        <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                            ${movie.genres?.name || 'Без жанра'} | 
                            ${movie.directors?.full_name || 'Режиссер не указан'} |
                            ⭐ ${movie.rating || 'N/A'} |
                            ${movie.duration_minutes || '??'} мин.
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                            ${movie.plot ? movie.plot.substring(0, 100) + '...' : 'Нет описания'}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-secondary" onclick="editMovie(${movie.id})">Ред.</button>
                        <button class="btn" onclick="deleteMovie(${movie.id})" style="background: var(--soft-red);">Удл.</button>
                    </div>
                </div>
            `).join('');
        }

        async function addMovie() {
            try {
                const movieData = {
                    title: document.getElementById('movieTitle').value,
                    release_year: parseInt(document.getElementById('movieYear').value),
                    genre_id: document.getElementById('movieGenre').value || null,
                    director_id: document.getElementById('movieDirector').value || null,
                    country: document.getElementById('movieCountry').value || null,
                    duration_minutes: document.getElementById('movieDuration').value ? 
                        parseInt(document.getElementById('movieDuration').value) : null,
                    plot: document.getElementById('moviePlot').value || null,
                    budget: document.getElementById('movieBudget').value ? 
                        parseInt(document.getElementById('movieBudget').value) : null,
                    rating: document.getElementById('movieRating').value ? 
                        parseFloat(document.getElementById('movieRating').value) : null,
                    age_rating: document.getElementById('movieAgeRating').value || null,
                    poster: document.getElementById('moviePoster').value || null
                };

                const { data, error } = await supabase
                    .from('movies')
                    .insert([movieData])
                    .select();

                if (error) throw error;

                alert('Фильм успешно добавлен!');
                document.getElementById('movieForm').reset();
                await loadMovies();
                await loadStats();
            } catch (error) {
                console.error('Ошибка добавления фильма:', error);
                alert('Ошибка при добавлении фильма: ' + error.message);
            }
        }

        async function deleteMovie(movieId) {
            if (confirm('Вы уверены, что хотите удалить этот фильм?')) {
                try {
                    const { error } = await supabase
                        .from('movies')
                        .delete()
                        .eq('id', movieId);

                    if (error) throw error;

                    alert('Фильм удален!');
                    await loadMovies();
                    await loadStats();
                } catch (error) {
                    console.error('Ошибка удаления:', error);
                    alert('Ошибка при удалении фильма: ' + error.message);
                }
            }
        }

        // === ФУНКЦИИ ДЛЯ РЕЖИССЕРОВ ===
        async function loadDirectors() {
            try {
                const { data: directors, error } = await supabase
                    .from('directors')
                    .select('*')
                    .order('full_name');

                if (error) throw error;

                displayDirectors(directors);
            } catch (error) {
                console.error('Ошибка загрузки режиссеров:', error);
                document.getElementById('directorsList').innerHTML = 
                    '<div class="loading">Ошибка загрузки режиссеров: ' + error.message + '</div>';
            }
        }

        function displayDirectors(directors) {
            const container = document.getElementById('directorsList');
            
            if (!directors || directors.length === 0) {
                container.innerHTML = '<div class="loading">Режиссеры не найдены</div>';
                return;
            }

            container.innerHTML = directors.map(director => `
                <div class="item-card">
                    <div style="flex: 1;">
                        <strong>${director.full_name}</strong>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                            ${director.birth_year ? 'Год рождения: ' + director.birth_year : 'Год рождения не указан'} |
                            ${director.country || 'Страна не указана'}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-secondary" onclick="editDirector(${director.id})">Ред.</button>
                        <button class="btn" onclick="deleteDirector(${director.id})" style="background: var(--soft-red);">Удл.</button>
                    </div>
                </div>
            `).join('');
        }

        async function addDirector() {
            try {
                const directorData = {
                    full_name: document.getElementById('directorName').value,
                    birth_year: document.getElementById('directorBirthYear').value ? 
                        parseInt(document.getElementById('directorBirthYear').value) : null,
                    country: document.getElementById('directorCountry').value || null
                };

                const { data, error } = await supabase
                    .from('directors')
                    .insert([directorData])
                    .select();

                if (error) throw error;

                alert('Режиссер успешно добавлен!');
                document.getElementById('directorForm').reset();
                await loadDirectors();
                await loadStats();
                await populateSelects();
            } catch (error) {
                console.error('Ошибка добавления режиссера:', error);
                alert('Ошибка при добавлении режиссера: ' + error.message);
            }
        }

        async function deleteDirector(directorId) {
            if (confirm('Вы уверены, что хотите удалить этого режиссера?')) {
                try {
                    const { error } = await supabase
                        .from('directors')
                        .delete()
                        .eq('id', directorId);

                    if (error) throw error;

                    alert('Режиссер удален!');
                    await loadDirectors();
                    await loadStats();
                    await populateSelects();
                } catch (error) {
                    console.error('Ошибка удаления:', error);
                    alert('Ошибка при удалении режиссера: ' + error.message);
                }
            }
        }

        // === ФУНКЦИИ ДЛЯ ЖАНРОВ ===
        async function loadGenres() {
            try {
                const { data: genres, error } = await supabase
                    .from('genres')
                    .select('*')
                    .order('name');

                if (error) throw error;

                displayGenres(genres);
            } catch (error) {
                console.error('Ошибка загрузки жанров:', error);
                document.getElementById('genresList').innerHTML = 
                    '<div class="loading">Ошибка загрузки жанров: ' + error.message + '</div>';
            }
        }

        function displayGenres(genres) {
            const container = document.getElementById('genresList');
            
            if (!genres || genres.length === 0) {
                container.innerHTML = '<div class="loading">Жанры не найдены</div>';
                return;
            }

            container.innerHTML = genres.map(genre => `
                <div class="item-card">
                    <div style="flex: 1;">
                        <strong>${genre.name}</strong>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-secondary" onclick="editGenre(${genre.id})">Ред.</button>
                        <button class="btn" onclick="deleteGenre(${genre.id})" style="background: var(--soft-red);">Удл.</button>
                    </div>
                </div>
            `).join('');
        }

        async function addGenre() {
            try {
                const genreData = {
                    name: document.getElementById('genreName').value
                };

                const { data, error } = await supabase
                    .from('genres')
                    .insert([genreData])
                    .select();

                if (error) throw error;

                alert('Жанр успешно добавлен!');
                document.getElementById('genreForm').reset();
                await loadGenres();
                await loadStats();
                await populateSelects();
            } catch (error) {
                console.error('Ошибка добавления жанра:', error);
                alert('Ошибка при добавлении жанра: ' + error.message);
            }
        }

        async function deleteGenre(genreId) {
            if (confirm('Вы уверены, что хотите удалить этот жанр?')) {
                try {
                    const { error } = await supabase
                        .from('genres')
                        .delete()
                        .eq('id', genreId);

                    if (error) throw error;

                    alert('Жанр удален!');
                    await loadGenres();
                    await loadStats();
                    await populateSelects();
                } catch (error) {
                    console.error('Ошибка удаления:', error);
                    alert('Ошибка при удалении жанра: ' + error.message);
                }
            }
        }

        // Функции редактирования (заглушки)
        function editMovie(id) {
            alert(`Редактирование фильма ID: ${id} - функция в разработке`);
        }

        function editDirector(id) {
            alert(`Редактирование режиссера ID: ${id} - функция в разработке`);
        }

        function editGenre(id) {
            alert(`Редактирование жанра ID: ${id} - функция в разработке`);
        }
    </script>
</body>

</html>
